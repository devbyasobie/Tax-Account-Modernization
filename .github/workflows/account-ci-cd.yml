name: CI-CD Account Service (self-hosted)

on:
  push:
    branches: ["main"]
  workflow_dispatch: 

permissions:
  contents: read
  packages: write
  security-events: write

jobs:
  build-deploy:
    runs-on:
      - self-hosted
      - macOS
      - X64

    env:
      HOME: /Users/flyboytroy
      REGISTRY: ghcr.io
      IMAGE_OWNER: devbyasobie
      IMAGE_NAME: account-service

    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Set up JDK
        uses: actions/setup-java@v4
        with:
          java-version: '21'
          distribution: 'temurin'

      - name: Add SpotBugs + FindSecBugs
        working-directory: services/account-service
        run: |
          mvn -B -DskipTests=false test spotbugs:check

      - name: Install Trivy (mac self-hosted)
        run: |
          if ! command -v trivy >/dev/null 2>&1; then
            brew install aquasecurity/trivy/trivy
          fi
          trivy --version

      - name: Trivy FS scan (source) -> SARIF
        run: |
          trivy fs --exit-code 1 --ignore-unfixed \
            --severity HIGH,CRITICAL \
            --format sarif --output trivy-fs.sarif \
            . || true

      - name: Trivy config scan (K8s/IaC) -> SARIF
        run: |
          trivy config --exit-code 1 \
            --severity HIGH,CRITICAL \
            --format sarif --output trivy-config.sarif \
            infra/k8s || infa/k8s || true
            # the '|| true' is just to avoid failing if only one path exists;
            # the exit code will have already been set if HIGH/CRITICAL found.

      - name: Upload Trivy SARIF (fs)
        uses: github/codeql-action/upload-sarif@v3
        with:
          sarif_file: trivy-fs.sarif

      - name: Upload Trivy SARIF (config)
        uses: github/codeql-action/upload-sarif@v3
        with:
          sarif_file: trivy-config.sarif

      - name: Build with Maven
        working-directory: services/account-service
        run: mvn -B clean package -DskipTests

      - name: Build Docker image
        working-directory: services/account-service
        run: |
          docker build -t ${{ env.REGISTRY }}/${{ env.IMAGE_OWNER }}/${{ env.IMAGE_NAME }}:${{ github.sha }} .

      - name: Trivy image scan -> SARIF (fail on HIGH/CRITICAL)
        run: |
          trivy image --exit-code 1 --ignore-unfixed \
            --severity HIGH,CRITICAL \
            --format sarif --output trivy-image.sarif \
            ${{ env.REGISTRY }}/${{ env.IMAGE_OWNER }}/${{ env.IMAGE_NAME }}:${{ github.sha }}

      - name: Upload Trivy SARIF (image)
        uses: github/codeql-action/upload-sarif@v3
        with:
          sarif_file: trivy-image.sarif

      - name: Log in to GHCR
        run: |
          echo "${{ secrets.GITHUB_TOKEN }}" | docker login ${{ env.REGISTRY }} -u $GITHUB_ACTOR --password-stdin

      - name: Push image
        run: |
          docker push ${{ env.REGISTRY }}/${{ env.IMAGE_OWNER }}/${{ env.IMAGE_NAME }}:${{ github.sha }}

      - name: Preload image into minikube
        run: |
          minikube image load ${{ env.REGISTRY }}/${{ env.IMAGE_OWNER }}/${{ env.IMAGE_NAME }}:${{ github.sha }}

      # now that we're on your Mac, we can copy your real kube/minikube
      - name: Copy kube + minikube
        run: |
          mkdir -p $HOME/.kube
          if [ ! -f $HOME/.kube/config ]; then  
            cp /Users/flyboytroy/.kube/config $HOME/.kube/config
          fi 
          mkdir -p $HOME/.minikube
          cp -R /Users/flyboytroy/.minikube/* $HOME/.minikube/ || true

      - name: Deploy to Kubernetes (local minikube)
        run: |
          kubectl get ns tax-modernization || kubectl create ns tax-modernization

          RENDERED="$(sed "s|IMAGE_PLACEHOLDER|${{ env.REGISTRY }}/${{ env.IMAGE_OWNER }}/${{ env.IMAGE_NAME }}:${{ github.sha }}|g" infra/k8s/account-deployment.yaml)"
          echo "$RENDERED" | grep -q 'IMAGE_PLACEHOLDER' && { echo "‚ùå Placeholder not replaced"; exit 1; }
          echo "$RENDERED" | kubectl apply -f -

          kubectl rollout status deploy/account-service -n tax-modernization
